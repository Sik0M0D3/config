#!/bin/sh

# Show wifi 直 and percent strength or 睊 if none.
# Show  if connected to ethernet or  if none.
# Show  if a vpn connection is active

case $BLOCK_BUTTON in
    1) st -e nmtui; kill -38 $(pidof $STATUSBAR) ;;
    3) notify-send "爵 Internet module
\- Click to Manage Connetions
 : ethernet working
 : no ethernet
直 : wifi connection with quality
睊 : no wifi connection
 : wifi disabled
 : vpn is active" ;;
    6) st -e nvim "$0" ;;
esac

update() {
    sum=0
    for arg; do
        read -r i < "$arg"
        sum=$(( sum + i ))
    done
    cache=${XDG_CACHE_HOME:-$HOME/.cache}/${1##*/}
    [ -f "$cache" ] && read -r old < "$cache" || old=0
    printf %d\\n "$sum" > "$cache"
    printf %d\\n $(( sum - old ))
}

if grep -xq 'up' /sys/class/net/w*/operstate 2>/dev/null ; then
    wifiicon="$(awk '/^\s*w/ { print "^c#00FF00^ 直", int($3 * 100 / 70) "% " }' /proc/net/wireless)"
elif grep -xq 'down' /sys/class/net/w*/operstate 2>/dev/null ; then
    grep -xq '0x1003' /sys/class/net/w*/flags && wifiicon="^d^ 睊" || wifiicon="^c#FF0000^ ^d^"
fi

rx=$(update /sys/class/net/[ew]*/statistics/rx_bytes)
tx=$(update /sys/class/net/[ew]*/statistics/tx_bytes)

printf " ^c#A6E22E^ ﰬ %4sB's ^c#F92672^ﰵ %4sB's %s%s%s\n $wifiicon" $(numfmt --to=iec $rx $tx) "$wifiicon" "$(sed "s/down/^c#FF0000^ ^d^/;s/up/^c#00FF00^ ^d^/" /sys/class/net/e*/operstate 2>/dev/null)" "$(sed "s/.*/^c#FF8800^ ^d^/" /sys/class/net/tun*/operstate 2>/dev/null)"
