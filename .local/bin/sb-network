#!/bin/dash
# This are 2 scripts merged into 1, the original ones are in Luke Smith's github.
# Read the PLEASE_README file to know what this ↓ line below is for.
[ -r ~/.local/bin/cur_theme ] && . ~/.local/bin/cur_theme || exit

case $BLOCK_BUTTON in
  1) notify-network & ;;
  2) setsid -f st -e nmtui; kill -40 $(pidof dwmblocks) ;;
  3) pidof dunst > /dev/null && notify-send -t 7500 "󰖟 Nerwork Module:
  • Left Click to Show Network State.
  • Right Click to Edit the Connections.
  • Left Click + Shift to edit this Module.
  • Icon Info:
        󰜮 Download Speed/RX
        󰜷 Upload Speed/TX
        󰞉 Network Connected (Green)
        󰪎 Network Disconnected (Gray)
        󰒃 VPN is Active (Yellow)" ;;
  6) setsid -f st -e nvim "$0" ;;
esac

netstate=$(cat /sys/class/net/en*/operstate)
[ -r ~/.cache/netstate ] || echo $netstate > ~/.cache/netstate &
pidof dunst > /dev/null && [ $netstate != $(cat ~/.cache/netstate) ] \
  && echo $netstate > ~/.cache/netstate && notify-network &

if [ $netstatus != up ]; then
  printf "^d^󰪎^d^"
else
  update() {
    sum=0
    for arg; do
      read -r i < "$arg"
      sum=$(( sum + i ))
    done
    cache=${XDG_CACHE_HOME:-$HOME/.cache}/${1##*/}
    [ -f "$cache" ] && read -r old < "$cache" || old=0
    printf %d\\n "$sum" > "$cache"
    printf %d\\n $(( sum - old ))
  }
  rx=$(update /sys/class/net/[ew]*/statistics/rx_bytes)
  tx=$(update /sys/class/net/[ew]*/statistics/tx_bytes)
  printf "^c$orange^󰜮 %4sB's ^c$red^󰜷 %4sB's^d^ %s%s" $(numfmt --to=iec $rx $tx) \
    "$(sed "s/up/^c$green^󰞉^d^/" /sys/class/net/e*/operstate 2> /dev/null)" \
    "$(sed "s/.*/^c$yellow^󰒃^d^/" /sys/class/net/tun*/operstate 2> /dev/null)"
fi
